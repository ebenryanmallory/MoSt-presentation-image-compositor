const express=require("express"),cors=require("cors"),bodyParser=require("body-parser"),puppeteer=require("puppeteer"),app=express();app.use(cors({origin:!0})),app.use(bodyParser.json()),app.use(express.static(__dirname+"/public")),app.set("view engine","html"),app.get("/",(request,response)=>{response.render("index")}),app.post("/composite-image",async(request,response)=>{const browser=await puppeteer.launch({headless:!0,args:["--no-sandbox","--disable-setuid-sandbox"]}),page=await browser.newPage(),url=`${request.body.windowLocation}/composite-image-template/`;await page.goto(url,{waitUntil:"networkidle2"});let themeScript="";themeScript=themeScript.concat(`\n        document.querySelector('.background').style.background = "${request.body.color}";\n    `),request.body.leftFile&&(themeScript=themeScript.concat(`\n            document.querySelector('img#upper').src = "${request.body.leftFile}";\n        `)),request.body.rightFile&&(themeScript=themeScript.concat(`\n            document.querySelector('img#lower').src = "${request.body.rightFile}";\n        `)),await page.evaluate(javascript=>{const script=document.createElement("script");script.type="text/javascript",script.textContent=javascript,script.setAttribute("id","script"),document.body.parentElement.appendChild(script)},themeScript),await page.setViewport({width:800,height:1e3});const background=await page.$(".background"),boundingBox=await background.boundingBox(),screenShot=await page.screenshot({omitBackground:!0,path:"public/temp/result.png",clip:{x:boundingBox.x,y:boundingBox.y,width:Math.min(boundingBox.width,page.viewport().width),height:Math.min(boundingBox.height,page.viewport().height)}});response.send(screenShot),browser.close()});const PORT=process.env.PORT||8e3;app.listen(PORT,()=>{console.log(`App running - listening on port ${PORT}`)});